# –¢–µ—Å—Ç DTLS —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞

–≠—Ç–æ—Ç –ø—Ä–∏–º–µ—Ä –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ—Ç —Ä–∞–±–æ—Ç—É DTLS (Datagram Transport Layer Security) —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞ –¥–ª—è –∑–∞—â–∏—â–µ–Ω–Ω–æ–π –ø–µ—Ä–µ–¥–∞—á–∏ RTP –ø–∞–∫–µ—Ç–æ–≤.

## –ß—Ç–æ –¥–µ–ª–∞–µ—Ç —ç—Ç–æ—Ç —Ç–µ—Å—Ç

1. **–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤**: –°–æ–∑–¥–∞–µ—Ç —Å–∞–º–æ–ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã–µ X.509 —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã –¥–ª—è DTLS —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
2. **–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è TLS handshake**: –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –±–∞–∑–æ–≤—ã–π TLS handshake —á–µ—Ä–µ–∑ TCP –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
3. **–°–æ–∑–¥–∞–Ω–∏–µ DTLS —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞**: –°–æ–∑–¥–∞–µ—Ç DTLS —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π –¥–ª—è UDP
4. **–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è RTP —Å—Ç—Ä—É–∫—Ç—É—Ä—ã**: –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—É RTP –ø–∞–∫–µ—Ç–æ–≤ –¥–ª—è DTLS –ø–µ—Ä–µ–¥–∞—á–∏

## –û—Ç–ª–∏—á–∏—è –æ—Ç –ø–æ–ª–Ω–æ–≥–æ SIP –∑–≤–æ–Ω–∫–∞

### –ß—Ç–æ –µ—Å—Ç—å –≤ —ç—Ç–æ–º —Ç–µ—Å—Ç–µ:
- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–∞–º–æ–ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã—Ö X.509 —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤
- –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è TLS handshake —á–µ—Ä–µ–∑ TCP (–¥–ª—è –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω—ã—Ö —Ü–µ–ª–µ–π)
- –°–æ–∑–¥–∞–Ω–∏–µ DTLS —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞ —Å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π –¥–ª—è RTP
- –ü–æ–∫–∞–∑ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã RTP –ø–∞–∫–µ—Ç–æ–≤

### –ß–µ–≥–æ –Ω–µ—Ç –≤ —ç—Ç–æ–º —Ç–µ—Å—Ç–µ:
- **SIP —Å–∏–≥–Ω–∞–ª–∏–∑–∞—Ü–∏—è**: –ù–µ—Ç INVITE, REGISTER, BYE –∏ –¥—Ä—É–≥–∏—Ö SIP —Å–æ–æ–±—â–µ–Ω–∏–π
- **SDP —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ**: –ù–µ—Ç –æ–±–º–µ–Ω–∞ –º–µ–¥–∏–∞-–ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ —á–µ—Ä–µ–∑ SDP offer/answer
- **–ú–µ–¥–∏–∞ –∫–æ–¥–µ–∫–∏**: –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Ç–æ–ª—å–∫–æ —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ, –±–µ–∑ —Ä–µ–∞–ª—å–Ω–æ–≥–æ –∞—É–¥–∏–æ
- **STUN/TURN**: –ù–µ—Ç NAT traversal –º–µ—Ö–∞–Ω–∏–∑–º–æ–≤
- **RTCP**: –ù–µ—Ç –æ—Ç—á–µ—Ç–æ–≤ –æ –∫–∞—á–µ—Å—Ç–≤–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
- **Jitter buffer**: –ù–µ—Ç –∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏–∏ —Å–µ—Ç–µ–≤–æ–π –∑–∞–¥–µ—Ä–∂–∫–∏
- **–î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ—Ä—Ç–∞–º–∏**: –ü–æ—Ä—Ç—ã –≤—ã–±–∏—Ä–∞—é—Ç—Å—è —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏

## –ö–∞–∫ –∑–∞–ø—É—Å—Ç–∏—Ç—å

```bash
go run ./cmd/test_dtls/main.go
```

## –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç

```
=== –¢–µ—Å—Ç DTLS Transport ===

--- –¢–µ—Å—Ç –±–∞–∑–æ–≤–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏ DTLS ---
üîê –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–∞–º–æ–ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã...
‚úì –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω—ã
‚úì DTLS —Å–µ—Ä–≤–µ—Ä —Å–æ–∑–¥–∞–Ω –Ω–∞ –∞–¥—Ä–µ—Å–µ 127.0.0.1:xxxxx

--- –¢–µ—Å—Ç DTLS handshake —á–µ—Ä–µ–∑ TCP ---
‚úì TCP —Å–µ—Ä–≤–µ—Ä —Å–ª—É—à–∞–µ—Ç –Ω–∞ 127.0.0.1:xxxxx
‚úì –ö–ª–∏–µ–Ω—Ç: handshake –∑–∞–≤–µ—Ä—à–µ–Ω
‚úì TLS Connection State:
  Version: 304
  CipherSuite: 1301
  HandshakeComplete: true
‚Üí –ö–ª–∏–µ–Ω—Ç –æ—Ç–ø—Ä–∞–≤–∏–ª: Hello from client
‚úì –°–µ—Ä–≤–µ—Ä: handshake –∑–∞–≤–µ—Ä—à–µ–Ω
‚Üê –°–µ—Ä–≤–µ—Ä –ø–æ–ª—É—á–∏–ª: Hello from client
‚Üê –ö–ª–∏–µ–Ω—Ç –ø–æ–ª—É—á–∏–ª: Hello from server
‚úÖ TLS handshake –∏ –æ–±–º–µ–Ω –¥–∞–Ω–Ω—ã–º–∏ —É—Å–ø–µ—à–Ω—ã

--- –¢–µ—Å—Ç DTLS —á–µ—Ä–µ–∑ UDP —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç ---
‚úì DTLS —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç —Å–æ–∑–¥–∞–Ω –Ω–∞ 127.0.0.1:xxxxx
  –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è: —É–¥–∞–ª–µ–Ω–Ω—ã–π –∞–¥—Ä–µ—Å 127.0.0.1:5555
  Handshake —Ç–∞–π–º–∞—É—Ç: 30s
  MTU: 1200 –±–∞–π—Ç
  Replay protection window: 64
‚ö† DTLS —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω (–Ω–æ—Ä–º–∞–ª—å–Ω–æ –¥–ª—è –Ω–µ—Å–æ–µ–¥–∏–Ω–µ–Ω–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è)
‚úì Handshake –µ—â–µ –Ω–µ –∑–∞–≤–µ—Ä—à–µ–Ω (–æ–∂–∏–¥–∞–µ–º–æ)

‚úì –°–æ–∑–¥–∞–Ω —Ç–µ—Å—Ç–æ–≤—ã–π RTP –ø–∞–∫–µ—Ç:
  Version: 2
  PayloadType: 8 (PCMA)
  SequenceNumber: 12345
  Timestamp: 567890
  SSRC: 123456789
  Payload: Test DTLS RTP payload

üí° –í —Ä–µ–∞–ª—å–Ω–æ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏:
  1. –°–µ—Ä–≤–µ—Ä –∏ –∫–ª–∏–µ–Ω—Ç —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç DTLS —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
  2. –ü—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç handshake —Å –æ–±–º–µ–Ω–æ–º —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞–º–∏
  3. –ü–æ—Å–ª–µ handshake –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –∑–∞—â–∏—â–µ–Ω–Ω–∞—è –ø–µ—Ä–µ–¥–∞—á–∞ RTP
  4. –í—Å–µ RTP –ø–∞–∫–µ—Ç—ã —à–∏—Ñ—Ä—É—é—Ç—Å—è –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
  5. –ü–æ–ª—É—á–∞—Ç–µ–ª—å —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤—ã–≤–∞–µ—Ç –ø–∞–∫–µ—Ç—ã –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è

‚úÖ –¢–µ—Å—Ç DTLS —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ!
‚úÖ –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—à–ª–∏ —É—Å–ø–µ—à–Ω–æ!
```

## –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ —Ä–µ–∞–ª—å–Ω–æ–º —Å–æ—Ñ—Ç—Ñ–æ–Ω–µ

–í —Ä–µ–∞–ª—å–Ω–æ–º —Å–æ—Ñ—Ç—Ñ–æ–Ω–µ DTLS —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞–∫ —á–∞—Å—Ç—å –±–æ–ª–µ–µ —Å–ª–æ–∂–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã:

1. SIP UA —Å–æ–≥–ª–∞—Å–æ–≤—ã–≤–∞–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —á–µ—Ä–µ–∑ SDP
2. MediaBuilder —Å–æ–∑–¥–∞–µ—Ç DTLS —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ SDP –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
3. RTP —Å–µ—Å—Å–∏—è –∏—Å–ø–æ–ª—å–∑—É–µ—Ç DTLS —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç –¥–ª—è –∑–∞—â–∏—â–µ–Ω–Ω–æ–π –ø–µ—Ä–µ–¥–∞—á–∏ –∞—É–¥–∏–æ
4. RTCP –æ—Ç—á–µ—Ç—ã —Ç–∞–∫–∂–µ –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ –∑–∞—â–∏—â–µ–Ω–Ω—ã–π –∫–∞–Ω–∞–ª
5. –ü—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –∑–≤–æ–Ω–∫–∞ –≤—Å–µ —Ä–µ—Å—É—Ä—Å—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ—Å–≤–æ–±–æ–∂–¥–∞—é—Ç—Å—è

–≠—Ç–æ—Ç —Ç–µ—Å—Ç –∏–∑–æ–ª–∏—Ä—É–µ—Ç –∏ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Ç–æ–ª—å–∫–æ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω—ã–π —Å–ª–æ–π, —á—Ç–æ –ø–æ–ª–µ–∑–Ω–æ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ –ø—Ä–æ–±–ª–µ–º —Å —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ–º –∏ –ø–µ—Ä–µ–¥–∞—á–µ–π –¥–∞–Ω–Ω—ã—Ö.