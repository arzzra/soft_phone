# Чек-лист валидации исправлений пакета RTP

## Автоматизированная проверка качества

### 1. Базовая проверка компиляции
```bash
cd pkg/rtp
go build ./...
```
✅ Код должен компилироваться без ошибок

### 2. Запуск всех тестов
```bash
go test -v ./... > test_results.txt
```
✅ Все тесты должны проходить

### 3. Проверка на race conditions
```bash
go test -race -count=10 ./...
```
✅ Не должно быть race conditions (запустить 10 раз для надежности)

### 4. Проверка покрытия тестами
```bash
go test -cover ./...
```
✅ Покрытие должно быть не менее 70%

### 5. Детальное покрытие критических файлов
```bash
go test -coverprofile=coverage.out ./...
go tool cover -html=coverage.out -o coverage.html
# Проверить покрытие для:
# - session.go (минимум 80%)
# - metrics_collector.go (минимум 80%)
# - transport_dtls.go (минимум 75%)
```

### 6. Benchmark тесты
```bash
go test -bench=. -benchmem ./... > benchmark_after.txt
# Сравнить с benchmark_before.txt
```
✅ Производительность не должна ухудшиться более чем на 5%

### 7. Проверка линтером
```bash
golangci-lint run ./...
```
✅ Не должно быть ошибок уровня error

### 8. Проверка на утечки памяти
```bash
go test -memprofile=mem.prof -run=TestSession ./...
go tool pprof -top mem.prof | head -20
```
✅ Не должно быть неожиданных аллокаций

## Ручная проверка критических исправлений

### 1. Проверка обработки ошибок

Убедиться что в следующих файлах ВСЕ ошибки обрабатываются:
- [ ] session.go - нет игнорируемых ошибок
- [ ] rtp_session.go - все вызовы проверяют err
- [ ] rtcp_session.go - все вызовы проверяют err
- [ ] transport_*.go - все сетевые операции проверяют ошибки

Команда для быстрой проверки:
```bash
# Не должно быть результатов
grep -n "_ =" *.go | grep -v "_test.go"
```

### 2. Проверка мьютексов

- [ ] metrics_collector.go не копирует структуры с мьютексами
- [ ] Все структуры с sync.Mutex/sync.RWMutex передаются по указателю
- [ ] Методы возвращают копии данных, а не структур с мьютексами

### 3. Проверка DTLS безопасности

- [ ] transport_dtls.go защищен от множественных соединений
- [ ] Есть map для отслеживания соединений по IP
- [ ] Старые соединения корректно закрываются

### 4. Проверка валидации данных

- [ ] SendAudio() проверяет размер данных
- [ ] SendAudio() проверяет что сессия активна
- [ ] Все публичные методы валидируют входные параметры

## Stress тестирование

### 1. Тест на большое количество сессий
```bash
go test -run=TestStress -timeout=5m ./...
```
✅ Должен выдержать 1000+ одновременных сессий

### 2. Тест на длительную работу
```bash
go test -run=TestLongRunning -timeout=30m ./...
```
✅ Не должно быть утечек памяти после 30 минут работы

### 3. Тест graceful shutdown
```bash
go test -run=TestGracefulShutdown ./...
```
✅ Все ресурсы должны освобождаться корректно

## Проверка специфичных сценариев

### 1. Тест обработки ошибок
```go
// Создать тест который проверяет что при ошибке:
// - Ресурсы освобождаются
// - Ошибка возвращается корректно
// - Нет паники
```

### 2. Тест concurrent доступа
```go
// Создать тест с 100 горутинами которые:
// - Одновременно вызывают SendAudio()
// - Одновременно читают метрики
// - Одновременно останавливают/запускают сессию
```

### 3. Тест rate limiting
```go
// Проверить что rate limiter:
// - Ограничивает количество пакетов
// - Работает per-IP
// - Не блокирует легитимный трафик
```

## Финальная проверка перед merge

1. **Все автоматические тесты пройдены** ✅
2. **Нет регрессий в производительности** ✅
3. **Код review пройден** ✅
4. **Документация обновлена** ✅
5. **CHANGELOG обновлен** ✅

## Команда для полной проверки

```bash
#!/bin/bash
echo "=== Запуск полной проверки пакета RTP ==="

# Компиляция
echo "1. Проверка компиляции..."
if ! go build ./pkg/rtp/...; then
    echo "❌ Ошибка компиляции"
    exit 1
fi
echo "✅ Компиляция успешна"

# Тесты
echo "2. Запуск тестов..."
if ! go test ./pkg/rtp/...; then
    echo "❌ Тесты не прошли"
    exit 1
fi
echo "✅ Тесты пройдены"

# Race detector
echo "3. Проверка race conditions..."
if ! go test -race ./pkg/rtp/...; then
    echo "❌ Обнаружены race conditions"
    exit 1
fi
echo "✅ Race conditions не обнаружены"

# Линтер
echo "4. Проверка линтером..."
if ! golangci-lint run ./pkg/rtp/...; then
    echo "❌ Линтер нашел проблемы"
    exit 1
fi
echo "✅ Линтер не нашел проблем"

# Покрытие
echo "5. Проверка покрытия тестами..."
go test -cover ./pkg/rtp/... | grep -E "coverage: [0-9]+\.[0-9]+%"

echo "=== Проверка завершена успешно! ==="
```

## Критерии готовности к production

- [ ] Все P0 исправления внедрены и протестированы
- [ ] Security аудит пройден
- [ ] Performance benchmarks в норме
- [ ] Stress тесты пройдены
- [ ] Документация актуальна
- [ ] Monitoring и alerting настроены

После прохождения всех проверок пакет готов к использованию!