# План разработки: Проверка направления RTP сессий при отправке

## Резюме задачи
Необходимо модифицировать все методы отправки данных в медиа-сессиях, чтобы они учитывали направление (direction) RTP сессий. Данные должны отправляться только на сессии с направлениями `sendrecv` или `sendonly`.

## Архитектурный контекст

### Направления RTP сессий
- **DirectionSendRecv** - двунаправленная передача (можно отправлять и принимать)
- **DirectionSendOnly** - только отправка (можно только отправлять)  
- **DirectionRecvOnly** - только прием (нельзя отправлять)
- **DirectionInactive** - неактивна (нельзя ни отправлять, ни принимать)

### Текущая проблема
В текущей реализации методы отправки данных игнорируют направление RTP сессий и отправляют данные на все сессии, включая те, которые имеют направление `recvonly` или `inactive`.

## Требования к реализации

### 1. Функциональные требования
- Все методы отправки должны проверять направление RTP сессии перед отправкой
- Данные должны отправляться только на сессии с `CanSend() == true`
- Сессии с направлением `recvonly` или `inactive` должны пропускаться без генерации ошибок
- Буферизация должна учитывать направление сессий

### 2. Нефункциональные требования
- Минимальное влияние на производительность
- Сохранение обратной совместимости API
- Отсутствие breaking changes в публичном интерфейсе
- Добавление debug-логирования для отладки

## Детальный план изменений

### Фаза 1: Модификация основных методов отправки

#### 1.1. Метод `sendRTPPacket` (pkg/media/session.go, строки 1551-1571)
**Приоритет**: Высокий
**Описание**: Основной метод отправки RTP пакетов

**Изменения**:
- Добавить проверку `rtpSession.CanSend()` перед вызовом `SendAudio`
- Пропускать сессии, которые не могут отправлять
- Сохранить обновление статистики только для отправленных пакетов

#### 1.2. Метод `WriteAudioDirect` (pkg/media/session.go, строки 780-794)
**Приоритет**: Высокий
**Описание**: Прямая запись аудио в RTP сессии

**Изменения**:
- Добавить проверку направления перед отправкой
- Обеспечить корректную обработку ошибок

#### 1.3. Метод `SendDTMF` (pkg/media/session.go, строки 838-855)
**Приоритет**: Средний
**Описание**: Отправка DTMF сигналов

**Изменения**:
- Проверить направление перед отправкой DTMF пакетов
- Убедиться, что DTMF события корректно обрабатываются

### Фаза 2: Модификация буферизации

#### 2.1. Метод `addToAudioBuffer` (pkg/media/session.go, строки 1391-1400)
**Приоритет**: Высокий
**Описание**: Добавление данных в буферы сессий

**Изменения**:
- Получить доступ к RTP сессиям для проверки направления
- Не добавлять данные в буферы сессий, которые не могут отправлять
- Обеспечить thread-safe доступ к сессиям

#### 2.2. Метод `sendBufferedAudioForSession` (pkg/media/session.go, строки 1423-1475)
**Приоритет**: Средний
**Описание**: Отправка буферизованного аудио для конкретной сессии

**Изменения**:
- Проверить направление перед отправкой
- Очистить буфер для сессий, которые не могут отправлять

### Фаза 3: Добавление логирования и мониторинга

#### 3.1. Debug-логирование
**Приоритет**: Низкий
**Описание**: Добавить отладочное логирование для пропущенных сессий

**Изменения**:
- Логировать пропуск сессий с указанием ID и направления
- Использовать уровень Debug для минимального влияния на производительность

## План тестирования

### 1. Модульные тесты
- Тест отправки на сессии с различными направлениями
- Проверка, что данные НЕ отправляются на `recvonly` и `inactive`
- Тест корректной работы DTMF с учетом направления
- Тест буферизации с различными направлениями

### 2. Интеграционные тесты
- Проверка работы в многосессионной среде
- Тест изменения направления во время активного вызова
- Проверка совместимости с существующим кодом

### 3. Регрессионные тесты
- Убедиться, что все существующие тесты проходят
- Проверить отсутствие побочных эффектов

## Оценка рисков

### 1. Технические риски
- **Риск**: Возможные проблемы с многопоточностью при доступе к направлению
- **Митигация**: Использование существующих мьютексов и thread-safe методов

### 2. Риски совместимости
- **Риск**: Изменение поведения может повлиять на существующие интеграции
- **Митигация**: Изменения соответствуют стандартам SIP/SDP и являются исправлением ошибки

## Критерии приемки

1. Все методы отправки проверяют направление RTP сессий
2. Данные отправляются только на сессии с `sendrecv` или `sendonly`
3. Отсутствуют регрессии в существующих тестах
4. Добавлены новые тесты для проверки функциональности
5. Код успешно проходит линтер (`golangci-lint run`)
6. Производительность не деградирует более чем на 1%

## Порядок выполнения

1. **Шаг 1**: Модификация метода `sendRTPPacket`
2. **Шаг 2**: Модификация метода `WriteAudioDirect`
3. **Шаг 3**: Модификация метода `SendDTMF`
4. **Шаг 4**: Модификация буферизации (`addToAudioBuffer`, `sendBufferedAudioForSession`)
5. **Шаг 5**: Добавление логирования
6. **Шаг 6**: Написание и запуск тестов
7. **Шаг 7**: Запуск линтера и исправление замечаний
8. **Шаг 8**: Финальная проверка и документирование

## Метрики успеха

- 100% покрытие тестами измененного кода
- 0 критических замечаний от линтера
- Отсутствие регрессий в существующих тестах
- Корректная работа с различными направлениями RTP сессий