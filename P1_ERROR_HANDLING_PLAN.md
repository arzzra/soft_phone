# План реализации улучшенной обработки ошибок P1

## Дата: 2025-07-09

## Обзор
После успешного исправления критических проблем безопасности P0, необходимо реализовать систему структурированного логирования и улучшенной обработки ошибок для повышения надежности и наблюдаемости системы.

## Текущие проблемы P1

### 1. Игнорируемые ошибки
Найдено 19 мест где ошибки игнорируются с помощью `_ =`:

#### dialog.go
- Строка 444, 447: Игнорируются ошибки изменения состояния state machine
- Строка 724: Игнорируется ошибка обработки Route headers
- Строка 879, 888, 892: Игнорируются ошибки отправки NOTIFY
- Строка 963: Игнорируется ошибка валидации ответа
- Строка 984: Игнорируется ошибка обновления Dialog ID
- Строка 1000, 1009, 1013: Игнорируются ошибки событий state machine
- Строка 1043, 1098: Игнорируются ошибки получения тега

#### manager.go
- Строка 325: Игнорируется ошибка завершения диалога

#### uasuac.go
- Строка 87: Игнорируется ошибка парсинга порта
- Строка 119, 128, 152: Игнорируются ошибки отправки ответов
- Строка 133, 144: Игнорируются ошибки обработки запросов

### 2. Отсутствие структурированного логирования
- Нет единой системы логирования
- Отсутствуют контекстные данные в логах
- Нет возможности фильтрации и анализа логов

### 3. Отсутствие механизмов повторных попыток
- Нет retry логики для транзиентных ошибок
- Отсутствует экспоненциальный backoff
- Нет circuit breaker паттерна

### 4. Отсутствие panic recovery
- Горутины не защищены от паники
- Нет централизованного восстановления после паники

## План реализации

### Фаза 1: Создание системы логирования (2 часа)

#### 1.1 Создать pkg/dialog/logger.go
```go
// Интерфейс логгера с поддержкой структурированного логирования
type Logger interface {
    Debug(msg string, fields ...Field)
    Info(msg string, fields ...Field)
    Warn(msg string, fields ...Field)
    Error(msg string, fields ...Field)
    WithFields(fields ...Field) Logger
    WithContext(ctx context.Context) Logger
}

// Поля для структурированного логирования
type Field struct {
    Key   string
    Value interface{}
}

// Реализация с использованием slog (Go 1.21+)
type SlogLogger struct {
    logger *slog.Logger
    fields []Field
}
```

#### 1.2 Добавить логирование во все места с игнорируемыми ошибками
- Заменить все `_ = err` на правильное логирование
- Добавить контекстную информацию (dialog ID, call ID, method)
- Использовать appropriate уровни логирования

### Фаза 2: Создание механизма повторных попыток (1.5 часа)

#### 2.1 Создать pkg/dialog/retry.go
```go
// Конфигурация повторных попыток
type RetryConfig struct {
    MaxAttempts     int
    InitialDelay    time.Duration
    MaxDelay        time.Duration
    Multiplier      float64
    JitterFactor    float64
}

// Функция с повторными попытками
func WithRetry(ctx context.Context, config RetryConfig, fn func() error) error

// Проверка транзиентных ошибок
func IsRetriableError(err error) bool
```

#### 2.2 Применить retry логику
- Для сетевых операций (отправка запросов/ответов)
- Для операций с состоянием (state machine transitions)
- Для операций с внешними системами

### Фаза 3: Добавление panic recovery (1 час)

#### 3.1 Создать безопасные обертки для горутин
```go
// Безопасный запуск горутины с recovery
func SafeGo(logger Logger, fn func()) {
    go func() {
        defer func() {
            if r := recover(); r != nil {
                logger.Error("горутина завершилась с паникой",
                    Field{"panic", r},
                    Field{"stack", debug.Stack()})
            }
        }()
        fn()
    }()
}
```

#### 3.2 Обновить все места запуска горутин
- В manager.go для фоновых задач
- В dialog.go для асинхронных операций
- В uasuac.go для обработчиков

### Фаза 4: Интеграция и тестирование (1.5 часа)

#### 4.1 Обновить существующий код
- Интегрировать логгер во все структуры
- Добавить конфигурацию логирования
- Обновить тесты

#### 4.2 Добавить метрики
- Счетчики ошибок по типам
- Гистограммы времени выполнения с retry
- Счетчики паник и восстановлений

## Приоритеты реализации

1. **Высокий приоритет**
   - Логирование игнорируемых ошибок в критических местах (state machine, отправка ответов)
   - Panic recovery для всех горутин
   
2. **Средний приоритет**
   - Retry логика для сетевых операций
   - Структурированное логирование с контекстом
   
3. **Низкий приоритет**
   - Метрики и мониторинг
   - Circuit breaker паттерн

## Конкретные изменения в файлах

### dialog.go
- Строки 444, 447: Добавить логирование ошибок state machine с уровнем WARN
- Строка 724: Логировать ошибки обработки headers с уровнем ERROR
- Строки 879, 888, 892: Добавить retry для NOTIFY с логированием
- Строка 963: Логировать ошибки валидации с уровнем WARN
- Строка 984: Критическая ошибка - логировать с ERROR и метриками
- Строки 1000, 1009, 1013: Логировать переходы состояний с INFO/WARN

### manager.go
- Строка 325: Добавить retry и логирование для Terminate()
- Добавить panic recovery для всех горутин

### uasuac.go
- Строка 87: Вернуть ошибку вместо игнорирования
- Строки 119, 128, 152: Добавить retry с экспоненциальным backoff
- Строки 133, 144: Логировать с полным контекстом запроса

## Критерии успеха

1. Все игнорируемые ошибки обрабатываются и логируются
2. Все горутины защищены от паники
3. Критические операции имеют retry механизм
4. Логи структурированы и содержат достаточно контекста для отладки
5. Система продолжает работать при частичных сбоях
6. Линтер не находит новых проблем

## Команды для проверки

```bash
# Проверка игнорируемых ошибок
grep -n "_ =" pkg/dialog/*.go | grep -v "_test.go"

# Запуск линтера
golangci-lint run ./pkg/dialog/...

# Проверка покрытия тестами
go test -coverprofile=coverage.out ./pkg/dialog/...
go tool cover -html=coverage.out

# Проверка на гонки данных
go test -race ./pkg/dialog/...
```