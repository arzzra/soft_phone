# План разработки для исправления обработки адреса в Dialog

## Проблема
В текущей реализации в файле `pkg/dialog2/dialog/requests.go` в методе `makeRequest`:
1. Используется несуществующее поле `uu.config.Hosts[0]` и `uu.config.Port` 
2. Есть опечатка `uu.confi` в строке 126
3. Адрес для исходящего запроса берется из конфигурации, а должен браться из заголовка `To` входящего запроса

## Анализ текущей архитектуры

### Структуры данных:
- `Config` содержит массив `TransportConfigs []TransportConfig`
- `TransportConfig` содержит поля `Host string` и `Port int`
- `Request.To()` возвращает `*ToHeader` с полем `Address Uri`
- `Uri` содержит поля `Host string` и `Port int`
- `Request.Laddr` имеет тип `sip.Addr{IP net.IP, Hostname string, Port int}`

### Текущий поток данных:
1. Dialog создается с профилем
2. При создании запроса вызывается `makeRequest`
3. `makeRequest` пытается взять IP из несуществующего поля конфигурации
4. Создается `Laddr` с неправильными данными

## План исправления

### Задача 1: Исправить структуру Config
**Цель**: Определить, откуда должны браться Hosts и Port

**Шаги**:
1. Проанализировать использование `config.Hosts` во всех файлах (найдено 3 места)
2. Определить правильный источник данных (TransportConfigs)
3. Варианты решения:
   - Вариант A: Добавить поля `Hosts []string` и `Port int` в структуру Config для обратной совместимости
   - Вариант B: Переписать код для использования `TransportConfigs[0].Host` и `TransportConfigs[0].Port`
   - Вариант C: Создать вспомогательные методы `GetDefaultHost()` и `GetDefaultPort()` в UACUAS

### Задача 2: Исправить метод makeRequest
**Цель**: Правильно получать адрес из заголовка To входящего запроса

**Шаги**:
1. Добавить параметр входящего запроса в метод `makeRequest` или сохранить его в Dialog
2. Получать `Host` и `Port` из `request.To().Address`
3. Убрать использование `net.ParseIP` и работать напрямую с Host из Uri
4. Исправить опечатку `uu.confi`

### Задача 3: Обновить вызовы makeRequest
**Цель**: Передать входящий запрос во все места вызова makeRequest

**Шаги**:
1. Найти все вызовы `makeRequest` в коде
2. Обновить сигнатуру метода
3. Передавать правильный контекст запроса

### Задача 4: Рефакторинг транспортной логики
**Цель**: Правильно использовать TransportConfig

**Шаги**:
1. Создать метод для выбора подходящего транспорта из TransportConfigs
2. Использовать первый доступный транспорт или выбирать по типу
3. Обновить инициализацию UACUAS

### Задача 5: Тестирование
**Цель**: Убедиться, что изменения работают корректно

**Шаги**:
1. Написать unit-тесты для makeRequest
2. Проверить правильность формирования Laddr
3. Проверить интеграцию с реальными SIP-запросами

## Детальная реализация

### Вариант 1: Минимальные изменения (РЕКОМЕНДУЕМЫЙ)
1. Добавить поле `initReq *sip.Request` в структуру Dialog (уже существует!)
2. Сохранять входящий запрос в `newUAS`: `session.initReq = req`
3. В `makeRequest` использовать данные из `To` заголовка входящего запроса:
   ```go
   // Получаем адрес из заголовка To входящего запроса
   if s.initReq != nil && s.uaType == UAS {
       toHeader := s.initReq.To()
       if toHeader != nil {
           newRequest.Laddr = sip.Addr{
               Hostname: toHeader.Address.Host,
               Port: toHeader.Address.Port,
           }
       }
   } else {
       // Для исходящих вызовов (UAC) использовать первый транспорт
       if len(uu.config.TransportConfigs) > 0 {
           tc := uu.config.TransportConfigs[0]
           newRequest.Laddr = sip.Addr{
               Hostname: tc.Host,
               Port: tc.Port,
           }
       }
   }
   ```

### Вариант 2: Рефакторинг архитектуры
1. Передавать контекст запроса через параметры
2. Создать отдельные методы для входящих и исходящих запросов
3. Использовать паттерн Builder для создания запросов

## Риски и ограничения
1. Изменение сигнатуры `makeRequest` может затронуть много кода
2. Нужно учитывать случаи, когда Port = 0 (использовать порт по умолчанию)
3. Необходимо обработать случай пустого массива TransportConfigs

## Приоритет задач
1. **Критично**: Задача 1 - исправить структуру Config (блокирует остальные задачи)
2. **Критично**: Задача 2 - исправить makeRequest и опечатку
3. **Важно**: Задача 3 - обновить newUAS для сохранения initReq
4. **Желательно**: Задача 4 - рефакторинг транспортов
5. **Обязательно**: Задача 5 - тестирование

## Оценка времени
- Задача 1: 30 минут (добавить поля в Config)
- Задача 2: 1 час (исправить makeRequest)
- Задача 3: 15 минут (добавить одну строку в newUAS)
- Задача 4: 2 часа (рефакторинг)
- Задача 5: 2 часа (тестирование)

**Итого**: ~5.5 часов работы

## Последовательность выполнения
1. Добавить поля `Hosts []string` и `Port int` в структуру Config
2. Исправить опечатку `uu.confi` на правильное поле
3. Добавить `session.initReq = req` в функцию newUAS
4. Обновить логику в makeRequest для использования данных из To заголовка
5. Запустить линтер и исправить все предупреждения
6. Написать тесты для проверки правильности работы