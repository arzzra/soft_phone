# Code Review: –ø–∞–∫–µ—Ç dialog

## –ö—Ä–∞—Ç–∫–∞—è —Å–≤–æ–¥–∫–∞

–ü–∞–∫–µ—Ç `dialog` –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç —Å–æ–±–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é SIP –¥–∏–∞–ª–æ–≥–æ–≤ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π INVITE, BYE, REFER (call transfer) –∏ –¥—Ä—É–≥–∏—Ö SIP –æ–ø–µ—Ä–∞—Ü–∏–π. –ü–∞–∫–µ—Ç –∏–º–µ–µ—Ç —Ö–æ—Ä–æ—à—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É, –Ω–æ —Å–æ–¥–µ—Ä–∂–∏—Ç –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã —Å thread safety –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º —Ä–µ—Å—É—Ä—Å–∞–º–∏, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å –ø–µ—Ä–µ–¥ production –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º.

## –°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã

### 1. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞
- ‚úÖ –ß–µ—Ç–∫–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –Ω–∞ —Å–ª–æ–∏: Stack ‚Üí Dialog ‚Üí Transaction
- ‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ (FSM –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è–º–∏)
- ‚úÖ –•–æ—Ä–æ—à–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã —Å –ø–æ–Ω—è—Ç–Ω—ã–º–∏ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞–º–∏
- ‚úÖ –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω –¥–ª—è REFER –æ–ø–µ—Ä–∞—Ü–∏–π (SendRefer + WaitRefer)

### 2. –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- ‚úÖ –û—Ç–ª–∏—á–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
- ‚úÖ –ü–æ–¥—Ä–æ–±–Ω—ã–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∫ –ø—É–±–ª–∏—á–Ω—ã–º –º–µ—Ç–æ–¥–∞–º
- ‚úÖ –°—Å—ã–ª–∫–∏ –Ω–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ RFC

### 3. –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å
- ‚úÖ –ü–æ–ª–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ SIP –¥–∏–∞–ª–æ–≥–æ–≤ —Å–æ–≥–ª–∞—Å–Ω–æ RFC 3261
- ‚úÖ –†–µ–∞–ª–∏–∑–∞—Ü–∏—è REFER (RFC 3515) –¥–ª—è call transfer
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ blind –∏ attended transfer
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ UAC/UAS —Ä–æ–ª–µ–π

## –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã

### 1. Race Conditions –∏ Thread Safety

#### üî¥ –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∑–∞—â–∏—Ç—ã —Å–æ—Å—Ç–æ—è–Ω–∏—è
```go
// dialog.go - –º–µ—Ç–æ–¥—ã —á–∏—Ç–∞—é—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ –±–µ–∑ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
func (d *Dialog) Accept(ctx context.Context, opts ...ResponseOpt) error {
    if d.state != DialogStateInit && d.state != DialogStateTrying {  // ‚ùå Race condition
        return fmt.Errorf("dialog must be in Init or Trying state")
    }
    // ...
}
```

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è**: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å RLock –¥–ª—è —á—Ç–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è:
```go
d.mutex.RLock()
state := d.state
d.mutex.RUnlock()
if state != DialogStateInit && state != DialogStateTrying {
    return fmt.Errorf("dialog must be in Init or Trying state")
}
```

#### üî¥ –ù–µ–±–µ–∑–æ–ø–∞—Å–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫ inviteTx
```go
// dialog.go - WaitAnswer()
func (d *Dialog) WaitAnswer(ctx context.Context) error {
    if d.inviteTx == nil {  // ‚ùå –ß–∏—Ç–∞–µ—Ç—Å—è –±–µ–∑ –∑–∞—â–∏—Ç—ã
        return fmt.Errorf("no active INVITE transaction")
    }
```

#### üî¥ –ö–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –ø–æ–ª–µ–π
```go
// dialog.go - setRemoteTag –∏ –¥—Ä—É–≥–∏–µ –º–µ—Ç–æ–¥—ã
d.remoteTag = tag        // ‚ùå –ü–∏—à–µ—Ç—Å—è –±–µ–∑ –º—å—é—Ç–µ–∫—Å–∞
d.remoteTarget = target  // ‚ùå –ü–∏—à–µ—Ç—Å—è –±–µ–∑ –º—å—é—Ç–µ–∫—Å–∞
```

### 2. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–∞–º–∏

#### üî¥ –î–≤–æ–π–Ω–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ –∫–∞–Ω–∞–ª–æ–≤
```go
func (d *Dialog) Close() error {
    // ‚ùå –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏, —á—Ç–æ –∫–∞–Ω–∞–ª—ã —É–∂–µ –∑–∞–∫—Ä—ã—Ç—ã
    close(d.responseChan)
    close(d.bodyChan)
    // ...
}
```

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è**: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å sync.Once:
```go
type Dialog struct {
    closeOnce sync.Once
    // ...
}

func (d *Dialog) Close() error {
    var err error
    d.closeOnce.Do(func() {
        close(d.responseChan)
        close(d.bodyChan)
        // ...
    })
    return err
}
```

#### üî¥ –£—Ç–µ—á–∫–∞ –≥–æ—Ä—É—Ç–∏–Ω
```go
// handlers.go - HandleIncomingRefer
go func() {
    // ‚ùå –ù–µ—Ç –∫–æ–Ω—Ç—Ä–æ–ª—è –∂–∏–∑–Ω–µ–Ω–Ω–æ–≥–æ —Ü–∏–∫–ª–∞ –≥–æ—Ä—É—Ç–∏–Ω—ã
    time.Sleep(100 * time.Millisecond)
    d.SendNotify(ctx, subscription, 200, "OK")
}()
```

### 3. –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

#### üî¥ –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ recover –≤ –∫–æ–ª–±—ç–∫–∞—Ö
```go
// dialog.go
if d.onStateChange != nil {
    d.onStateChange(d, prev, current)  // ‚ùå –ü–∞–Ω–∏–∫–∞ —É–±—å–µ—Ç –≥–æ—Ä—É—Ç–∏–Ω—É
}
```

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è**:
```go
if d.onStateChange != nil {
    func() {
        defer func() {
            if r := recover(); r != nil {
                d.logger.Error("callback panic", "error", r)
            }
        }()
        d.onStateChange(d, prev, current)
    }()
}
```

#### üî¥ –ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫ crypto/rand
```go
// dialog_internal.go
func generateID() string {
    b := make([]byte, 16)
    rand.Read(b)  // ‚ùå –û—à–∏–±–∫–∞ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è
    return fmt.Sprintf("%x", b)
}
```

### 4. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

#### ‚ö†Ô∏è –ù–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
```go
// tx.go
type Transaction struct {
    clientTx sip.ClientTransaction  // ‚ùå –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è
    serverTx sip.ServerTransaction  // ‚ùå –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è
}
```

#### ‚ö†Ô∏è –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —Ç–∞–π–º–µ—Ä–æ–≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
- –ù–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã SIP —Ç–∞–π–º–µ—Ä—ã (Timer A, B, F –∏ —Ç.–¥.)
- –≠—Ç–æ –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –∑–∞–≤–∏—Å–∞–Ω–∏—é —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π

#### ‚ö†Ô∏è –ù–µ–ø–æ–ª–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–æ–≤
```go
// stack.go
case "tls":
    // TODO: Implement TLS transport
    return nil, fmt.Errorf("TLS transport not yet supported")
```

## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

### 1. –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
- –†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ sync.Pool –¥–ª—è —á–∞—Å—Ç—ã—Ö –∞–ª–ª–æ–∫–∞—Ü–∏–π
- –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å –∫–∞—Ä—Ç–∞–º–∏ (–ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–µ –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞)
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å strings.Builder –≤–º–µ—Å—Ç–æ fmt.Sprintf –≥–¥–µ –≤–æ–∑–º–æ–∂–Ω–æ

### 2. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- –î–æ–±–∞–≤–∏—Ç—å —Ç–µ—Å—Ç—ã —Å —Ñ–ª–∞–≥–æ–º -race
- –î–æ–±–∞–≤–∏—Ç—å –±–µ–Ω—á–º–∞—Ä–∫–∏ –¥–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ø—É—Ç–µ–π
- –£–≤–µ–ª–∏—á–∏—Ç—å –ø–æ–∫—Ä—ã—Ç–∏–µ —Ç–µ—Å—Ç–∞–º–∏ (–æ—Å–æ–±–µ–Ω–Ω–æ error cases)

### 3. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- –î–æ–±–∞–≤–∏—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –≤—Å–µ—Ö –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —É—Ä–æ–≤–Ω–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –±–æ–ª–µ–µ –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ
- –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

## –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞–º –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### –í—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç (–±–ª–æ–∫–∏—Ä—É—é—â–∏–µ production)
1. –ò—Å–ø—Ä–∞–≤–∏—Ç—å –≤—Å–µ race conditions
2. –î–æ–±–∞–≤–∏—Ç—å –∑–∞—â–∏—Ç—É –æ—Ç –ø–∞–Ω–∏–∫ –≤ –∫–æ–ª–±—ç–∫–∞—Ö
3. –ò—Å–ø—Ä–∞–≤–∏—Ç—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≥–æ—Ä—É—Ç–∏–Ω–∞–º–∏ –∏ –∫–∞–Ω–∞–ª–∞–º–∏
4. –î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫ –¥–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π

### –°—Ä–µ–¥–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç
1. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Ç–∞–π–º–µ—Ä—ã —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
2. –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
3. –î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∫—É TLS —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞
4. –£–ª—É—á—à–∏—Ç—å —Ç–µ—Å—Ç—ã

### –ù–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç
1. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
2. –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏ (OPTIONS, MESSAGE –∏ —Ç.–¥.)
3. –£–ª—É—á—à–µ–Ω–∏–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–ü–∞–∫–µ—Ç –∏–º–µ–µ—Ç —Ö–æ—Ä–æ—à—É—é –æ—Å–Ω–æ–≤—É –∏ –ø—Ä–∞–≤–∏–ª—å–Ω—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É, –Ω–æ —Ç—Ä–µ–±—É–µ—Ç —Å–µ—Ä—å–µ–∑–Ω–æ–π –¥–æ—Ä–∞–±–æ—Ç–∫–∏ –≤ –æ–±–ª–∞—Å—Ç–∏ thread safety –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–µ—Å—É—Ä—Å–∞–º–∏. –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ø—Ä–æ–±–ª–µ–º –ø–∞–∫–µ—Ç –±—É–¥–µ—Ç –≥–æ—Ç–æ–≤ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é –≤ production –æ–∫—Ä—É–∂–µ–Ω–∏–∏.

### –û—Ü–µ–Ω–∫–∞: 6/10

**–ü–ª—é—Å—ã**: –•–æ—Ä–æ—à–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞, –æ—Ç–ª–∏—á–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ RFC  
**–ú–∏–Ω—É—Å—ã**: –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã —Å thread safety, –Ω–µ–ø–æ–ª–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π