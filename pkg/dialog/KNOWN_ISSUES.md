# Known Issues - Dialog Package

## Обнаруженные проблемы

### 1. TestMultipleConcurrentCalls - Race Condition
**Проблема**: Тест иногда падает с ошибкой "Fail in goroutine after TestMultipleConcurrentCalls has completed"

**Описание**: Горутины клиентов продолжают выполняться после завершения теста, что приводит к panic при попытке вызвать t.Errorf() после завершения теста.

**Место**: `dialog_test.go:330`

**Статус**: Требует исправления

**Решение**: Добавить правильную синхронизацию и ожидание завершения всех горутин перед выходом из теста.

---

### 2. Зависимости от sipgo

#### 2.1 CANCEL обработка
**Проблема**: sipgo не обрабатывает CANCEL автоматически

**Место**: `handlers.go:181`
```go
// TODO: sipgo должен сам обрабатывать CANCEL и отправлять 487
```

**Статус**: Ожидание обновления sipgo

#### 2.2 Отсутствие поддержки логирования
**Проблема**: sipgo не предоставляет опцию для настройки логирования

**Место**: `stack.go:214`
```go
// TODO: добавить опцию логирования когда она появится в sipgo
```

**Статус**: Ожидание обновления sipgo

#### 2.3 TLS конфигурация
**Проблема**: sipgo не поддерживает прямую передачу TLS конфига

**Место**: `stack.go:268`
```go
// TODO: sipgo не поддерживает прямую передачу TLS конфига
```

**Статус**: Ожидание обновления sipgo

---

### 3. NOTIFY обработка
**Проблема**: Сервер выдает предупреждения о необработанных NOTIFY запросах

**Логи**:
```
WARN SIP request handler not found caller=Server method=NOTIFY
```

**Описание**: После отправки REFER, диалог отправляет NOTIFY уведомления, но обработчик для них не зарегистрирован в sipgo сервере.

**Статус**: Требует добавления обработчика NOTIFY

---

### 4. re-INVITE в тестах
**Проблема**: Тесты re-INVITE работают, но получают только 100 Trying без финального ответа в некоторых случаях

**Описание**: Была исправлена логика ожидания финального ответа, но стоит проверить корректность обработки всех сценариев.

**Статус**: Частично исправлено, требует дополнительного тестирования

---

## Рекомендации по исправлению

### Приоритет 1 (Высокий):
1. Исправить race condition в TestMultipleConcurrentCalls
2. Добавить обработчик NOTIFY для корректной работы REFER

### Приоритет 2 (Средний):
3. Улучшить обработку re-INVITE для всех edge cases
4. Добавить более подробное логирование для отладки

### Приоритет 3 (Низкий):
5. Дождаться обновлений sipgo для CANCEL, логирования и TLS

---

## Дополнительные улучшения

### Возможные улучшения архитектуры:
1. **Транзакционный слой**: Добавить более надежное управление транзакциями
2. **Таймауты**: Добавить настраиваемые таймауты для различных операций
3. **Метрики**: Добавить сбор метрик для мониторинга производительности
4. **Обработка ошибок**: Улучшить обработку и классификацию ошибок

### Недостающая функциональность:
1. **UPDATE метод**: Для изменения сессии без re-INVITE
2. **PRACK**: Для надежных provisional ответов
3. **Session Timers**: Для автоматического обновления сессий
4. **Forking**: Поддержка параллельных звонков

---

## История изменений

### 2025-01-02
- Реализован парсинг Contact и Record-Route заголовков
- Добавлена полная поддержка REFER и Replaces
- Реализована поддержка re-INVITE
- Написано комплексное тестовое покрытие
- Обнаружены и задокументированы текущие проблемы