# Использование метода Cancel() для отмены INVITE транзакций

## Обзор

Метод `Cancel()` используется для отмены INVITE транзакций в состоянии `Proceeding` согласно RFC 3261, раздел 9.

## Основные характеристики

1. **Применимость**: Только для INVITE транзакций
2. **Состояние**: Можно вызывать только в состоянии `Proceeding` (после получения 1xx ответа)
3. **Thread-safe**: Безопасен для вызова из нескольких горутин одновременно
4. **Идемпотентность**: Многократные вызовы безопасны, CANCEL отправляется только один раз

## Пример использования

```go
// Создаем INVITE транзакцию
inviteTx := client.NewInviteTransaction(id, key, invite, transport, timers)

// Обрабатываем 100 Trying или 180 Ringing
inviteTx.HandleResponse(tryingResponse)

// Отменяем транзакцию
err := inviteTx.Cancel()
if err != nil {
    log.Printf("Ошибка отмены: %v", err)
}
```

## Поток сообщений

```
UAC                          UAS
 |                            |
 |---------- INVITE --------->|
 |                            |
 |<--------- 100 Trying ------|
 |                            |
 |<--------- 180 Ringing -----|
 |                            |
 |---------- CANCEL --------->|  <- Cancel() вызывается здесь
 |                            |
 |<--------- 200 OK (CANCEL) -|
 |                            |
 |<--- 487 Request Terminated-|
 |                            |
 |---------- ACK ------------>|
 |                            |
```

## Важные детали реализации

### Заголовки CANCEL

CANCEL запрос должен содержать те же заголовки, что и оригинальный INVITE:
- **Via**: Идентичный INVITE
- **From**: Идентичный INVITE
- **To**: Идентичный INVITE (без tag)
- **Call-ID**: Идентичный INVITE
- **CSeq**: Тот же номер, но метод CANCEL
- **Route**: Если присутствовал в INVITE

### Обработка ошибок

```go
// Ошибка неправильного состояния
err := tx.Cancel() // "can only cancel transaction in Proceeding state"

// Ошибка для non-INVITE транзакций
err := nonInviteTx.Cancel() // "CANCEL can only be sent for INVITE transactions"
```

### Создание CANCEL транзакции

CANCEL создает отдельную non-INVITE транзакцию, которая должна быть создана на уровне менеджера транзакций. Оригинальная INVITE транзакция продолжает ждать финального ответа (обычно 487 Request Terminated).

## Тестирование

Реализация включает следующие тесты:

1. **Базовая функциональность**: Успешная отправка CANCEL
2. **Проверка состояния**: Ошибки при неправильном состоянии
3. **Проверка метода**: Ошибка для non-INVITE транзакций
4. **Race conditions**: Безопасность при конкурентном доступе
5. **Интеграционные тесты**: Полный флоу отмены с ответами

## RFC 3261 Соответствие

Реализация полностью соответствует требованиям RFC 3261:
- Раздел 9.2: Построение CANCEL запроса
- Раздел 17.1.1.2: Обработка CANCEL в клиентских транзакциях
- Раздел 17.2.3: Обработка таймеров и состояний