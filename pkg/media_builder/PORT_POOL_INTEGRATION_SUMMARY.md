# Интеграция PortPool в mediaBuilder - Статус и План

## Что сделано:

1. **Обновлен BuilderConfig** (в config.go):
   - Добавлено поле `PortPool *PortPool` для передачи пула портов от менеджера

2. **Обновлен mediaBuilder** (в builder.go):
   - Добавлено поле `allocatedPorts []uint16` для отслеживания выделенных портов
   - Обновлен метод `allocatePort()`:
     - Для первого потока использует LocalPort из конфигурации
     - Для дополнительных потоков использует PortPool.Allocate()
     - Сохраняет выделенные порты для последующего освобождения
   - Обновлен метод `Close()`:
     - Освобождает все выделенные порты обратно в пул через PortPool.Release()

## Что осталось сделать:

### 1. Обновить BuilderManager (manager.go):
```go
// В методе CreateBuilder добавить передачу PortPool:
builderConfig := BuilderConfig{
    // ... существующие поля ...
    PortPool: m.portPool,  // <-- ДОБАВИТЬ ЭТО
}
```

### 2. Обновить ReleaseBuilder в BuilderManager:
- Порт основного потока уже освобождается менеджером
- Дополнительные порты теперь освобождаются в builder.Close()
- Возможно, нужно убрать дублирование освобождения основного порта

### 3. Написать тесты:
- Тест выделения портов для множественных потоков
- Тест освобождения портов при закрытии builder
- Тест обработки ошибок когда порты недоступны
- Тест работы без PortPool (fallback на простое смещение)

### 4. Важные моменты для рассмотрения:

#### Проблема двойного освобождения:
- Сейчас основной порт (LocalPort) выделяется менеджером и освобождается менеджером
- Но если builder использует PortPool для дополнительных портов, он не должен пытаться освободить основной порт
- Нужна логика для различения основного порта от дополнительных

#### Решение:
```go
// В allocatePort():
if len(b.mediaStreams) == 0 {
    // Не добавляем основной порт в allocatedPorts
    return b.config.LocalPort, nil
}

// Или в Close():
// Пропускаем основной порт при освобождении
for _, port := range b.allocatedPorts {
    if port != b.config.LocalPort {
        // освобождаем только дополнительные порты
    }
}
```

### 5. Потенциальные улучшения:
- Добавить метрики использования портов
- Добавить логирование для отладки
- Рассмотреть возможность резервирования блока портов для multi-stream сессий
- Добавить валидацию что выделенные порты четные (RTP требование)

## Критически важно:
1. Избежать двойного освобождения портов
2. Обеспечить корректную работу при отсутствии PortPool
3. Гарантировать освобождение всех портов даже при ошибках