# Стратегический план переписывания пакета dialog

## Резюме

На основе проведенного комплексного анализа пакета dialog и сравнения с sipgo v0.33.0, предлагается гибридный подход: использовать базовую функциональность sipgo, сохранив ценные кастомные расширения.

## Текущее состояние

### Проблемы:
1. **Значительное дублирование** функциональности sipgo (FSM, Dialog ID, транзакции)
2. **Избыточная сложность** - 5-состояний FSM вместо 3 в sipgo
3. **Производительность** - 2.5x больше памяти, 10x медленнее смена состояний
4. **Безопасность** - отсутствие лимитов, риски утечек памяти

### Ценные возможности:
1. **REFER/Replaces поддержка** - отсутствует в sipgo
2. **Безопасность** - rate limiting, валидация, криптографические теги
3. **Thread safety** - лучше чем в sipgo
4. **Мониторинг** - Prometheus метрики
5. **Retry механизмы** - application-level повторы

## Архитектура решения

### Гибридный подход - EnhancedDialog

```go
// Обертка над sipgo.Dialog с кастомными расширениями
type EnhancedDialog struct {
    *sipgo.Dialog           // Встроенная функциональность sipgo
    
    // Кастомные расширения
    security      *SecurityValidator
    referHandler  *ReferHandler
    retryManager  *RetryManager
    metrics       *MetricsCollector
    mu            sync.RWMutex      // Thread safety
}
```

## План реализации по фазам

### Фаза 1: Фундамент (Неделя 1)
**Цель**: Создать основу для миграции без нарушения работы существующего кода

#### Задачи:
1. **Создать адаптерные интерфейсы**
   - `IDialogAdapter` - мост между старым и новым API
   - `IDialogManager` - унифицированный интерфейс управления
   - Фабричные методы для создания диалогов

2. **Разработать EnhancedDialog структуру**
   - Встроить sipgo.Dialog
   - Сохранить существующие интерфейсы
   - Добавить конверторы состояний

3. **Настроить тестовую инфраструктуру**
   - Параллельные тесты старой и новой реализации
   - Бенчмарки производительности
   - Интеграционные тесты с OpenSIPS

#### Deliverables:
- [ ] pkg/dialog/adapter/interfaces.go
- [ ] pkg/dialog/adapter/enhanced_dialog.go
- [ ] pkg/dialog/adapter/state_converter.go
- [ ] pkg/dialog/testing/harness.go

### Фаза 2: Миграция ядра (Неделя 2)
**Цель**: Заменить дублирующуюся функциональность на sipgo

#### Задачи:
1. **Заменить FSM на sipgo состояния**
   ```go
   // Старое: 5 состояний
   StateNone → StateEarly → StateConfirmed → StateTerminating → StateTerminated
   
   // Новое: 3 состояния sipgo + кастомная логика
   DialogStateEstablished → DialogStateConfirmed → DialogStateEnded
   ```

2. **Мигрировать Dialog ID генерацию**
   - Использовать `sipgo.MakeDialogID()`
   - Сохранить криптографические теги для безопасности

3. **Упростить транзакционный слой**
   - Убрать дублирование транзакций
   - Оставить application-level retry

#### Deliverables:
- [ ] Рефакторинг state_machine.go
- [ ] Миграция dialog_id логики
- [ ] Упрощение transaction обработки

### Фаза 3: Оптимизация (Неделя 3)
**Цель**: Улучшить производительность и упростить архитектуру

#### Задачи:
1. **Оптимизировать DialogManager**
   - Удалить избыточные индексы (callIDIndex, tagIndex)
   - Использовать sipgo.DialogClientCache/DialogServerCache
   - Сохранить rate limiting и безопасность

2. **Упростить обработку заголовков**
   - Использовать sipgo парсеры
   - Оставить только бизнес-специфичную валидацию

3. **Оптимизация памяти**
   - Использовать sync.Pool для частых аллокаций
   - Уменьшить размер структур

#### Deliverables:
- [ ] Новый DialogManager с sipgo кешированием
- [ ] Оптимизированная обработка заголовков
- [ ] Профилирование и оптимизация памяти

### Фаза 4: Сохранение ценностей (Неделя 4)
**Цель**: Интегрировать уникальные возможности с новой архитектурой

#### Задачи:
1. **REFER/Replaces функциональность**
   - Портировать существующую реализацию
   - Интегрировать с sipgo диалогами
   - Добавить тесты совместимости

2. **Безопасность и валидация**
   - Сохранить SecurityValidator
   - Интегрировать rate limiting
   - Усилить валидацию входных данных

3. **Мониторинг и метрики**
   - Адаптировать Prometheus метрики
   - Добавить новые метрики sipgo
   - Создать дашборды

4. **Thread safety**
   - Обернуть sipgo.Dialog в thread-safe wrapper
   - Использовать sync.RWMutex для оптимизации
   - Тесты на race conditions

#### Deliverables:
- [ ] pkg/dialog/refer_handler.go (обновленный)
- [ ] pkg/dialog/security_enhanced.go
- [ ] pkg/dialog/metrics.go
- [ ] pkg/dialog/thread_safe_wrapper.go

## Метрики успеха

### Производительность
- [ ] Память на диалог: < 250 байт (сейчас 500)
- [ ] Смена состояния: < 20ns (сейчас 100ns)
- [ ] Поиск диалога: O(1), 1 операция (сейчас 3)

### Качество кода
- [ ] Покрытие тестами: > 85%
- [ ] Прохождение `go test -race`
- [ ] Прохождение `golangci-lint run`
- [ ] Отсутствие критических уязвимостей

### Функциональность
- [ ] 100% обратная совместимость API
- [ ] Сохранение REFER/Replaces
- [ ] Улучшенная безопасность
- [ ] Работающие метрики

## Риски и митигация

| Риск | Вероятность | Влияние | Митигация |
|------|------------|---------|-----------|
| Breaking changes в API | Высокая | Критично | Адаптерный слой, постепенная миграция |
| Потеря REFER функций | Средняя | Высокое | Тщательное тестирование, изоляция кода |
| Регрессия производительности | Низкая | Среднее | Continuous benchmarking |
| Несовместимость с sipgo | Средняя | Высокое | Форк sipgo при необходимости |

## Организация работы

### Команда
- **Agent O** (Orchestrator) - координация и планирование
- **Agent D** (Developer) - реализация кода
- **Agent R** (Reviewer) - код-ревью и валидация

### Процесс
1. **Ежедневные проверки**
   - Прогресс по задачам
   - Блокеры и риски
   - Метрики качества

2. **Недельные вехи**
   - Демо функциональности
   - Ревью архитектуры
   - Планирование следующей фазы

3. **Критерии готовности**
   - Прохождение всех тестов
   - Код-ревью пройдено
   - Документация обновлена
   - Метрики в норме

## Следующие шаги

1. **Немедленно**:
   - [ ] Создать feature branch `feature/dialog-sipgo-migration`
   - [ ] Настроить CI/CD для новой ветки
   - [ ] Создать каркас адаптерного слоя

2. **В течение 24 часов**:
   - [ ] Провести детальный анализ зависимостей
   - [ ] Создать прототип EnhancedDialog
   - [ ] Запустить первые бенчмарки

3. **К концу недели 1**:
   - [ ] Завершить Фазу 1
   - [ ] Продемонстрировать работающий адаптер
   - [ ] Получить одобрение на продолжение

## Критерии отмены проекта

Проект может быть остановлен если:
- Обнаружена фундаментальная несовместимость с sipgo
- Производительность деградирует более чем на 20%
- Невозможно сохранить критичную функциональность
- Трудозатраты превышают 6 недель

## Заключение

Гибридный подход позволит:
1. Уменьшить техдолг за счет использования проверенного sipgo
2. Сохранить уникальные бизнес-возможности
3. Улучшить производительность и надежность
4. Упростить поддержку и развитие

**Ожидаемый результат**: Современный, производительный и безопасный пакет dialog, соответствующий стандартам SIP и требованиям бизнеса.